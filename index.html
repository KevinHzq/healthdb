<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with Healthcare Databases • healthdb</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Working with Healthcare Databases">
<meta name="description" content="A system for identifying diseases or events from healthcare databases and preparing data for epidemiological studies. It includes capabilities not supported by SQL, such as matching strings by stringr style regular expressions, and can compute comorbidity scores (Quan et al. (2005) &lt;doi:10.1097/01.mlr.0000182534.19832.83&gt;) directly on a database server. The implementation is based on dbplyr with full tidyverse compatibility.">
<meta property="og:description" content="A system for identifying diseases or events from healthcare databases and preparing data for epidemiological studies. It includes capabilities not supported by SQL, such as matching strings by stringr style regular expressions, and can compute comorbidity scores (Quan et al. (2005) &lt;doi:10.1097/01.mlr.0000182534.19832.83&gt;) directly on a database server. The implementation is based on dbplyr with full tidyverse compatibility.">
<meta property="og:image" content="https://kevinhzq.github.io/healthdb/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">healthdb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="articles/healthdb.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KevinHzq/healthdb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="healthdb-">healthdb 
<a class="anchor" aria-label="anchor" href="#healthdb-"></a>
</h1>
</div>
<!-- badges: start -->

<!-- badges: end -->
<p>The goal of ‘healthdb’ is to provide a set of tools for identifying diseases or events from healthcare database and preparing data for epidemiological studies. It features abilities that are not natively support by database, such as matching strings by ‘stringr’ style regular expression and using ‘LIKE’ operator with multiple patterns in a vector. Three types of functions are included: interactive functions – for customizing complex definitions; call building functions – for batch execution of simple definition; miscellaneous functions – for data wrangling, computing age and comorbidity index, etc.</p>
<p><strong>The package is tested only on SQL Server and SQLite</strong> as we do not have access to other SQL dialects. Please report bugs if you encounter issues with other dialects.</p>
<p>Administrative health data are often stored on SQL database with strict security measures which may disable permission to write temporary tables. Writing queries without being able to cache intermediate results is challenging, especially when the data is too large to be downloaded from database into R (i.e., local memory) without some filtering process.</p>
<p>This package leverages ‘dbplyr’, particularly its ability to chain subqueries, in order to implement a common disease definition as a one-shot big query. Outputs are fully compatible with ‘dplyr’ functions.</p>
<p>Common disease definitions often are in the form of having n primary care/hospitalization/prescription records with some International Classification of Diseases (ICD) codes within some time span. See below for an example of implementing such case definition.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"healthdb"</span><span class="op">)</span></span></code></pre></div>
<p>You could also install the development version from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"KevinHzq/healthdb"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>We are going to implement the following case definition:</p>
<p>One or more hospitalization with a substance use disorder (SUD) ICD-9 diagnostic code, OR Two or more physician claims with a substance use disorder ICD-10 diagnostic code within one year.</p>
<p>Before we get started, please see <a href="https://solutions.posit.co/connections/db/getting-started/connect-to-database/" class="external-link">how to connect to a database</a> and <a href="https://solutions.posit.co/connections/db/getting-started/database-queries/" class="external-link">how to write query with ‘dbplyr’</a> if you don’t have experience of working with database in R.</p>
<p>First, let’s make a demo data sets for the two sources:</p>
<p>Physician claims</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KevinHzq/healthdb" class="external-link">healthdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make_test_dat() makes either a toy data.frame or database table in memory with known number of rows that satisfy the query we will show later</span></span>
<span><span class="va">claim_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_test_dat.html">make_test_dat</a></span><span class="op">(</span>vals_kept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"303"</span>, <span class="st">"304"</span>, <span class="st">"305"</span>, <span class="st">"291"</span>, <span class="st">"292"</span>, <span class="fu">str_glue</span><span class="op">(</span><span class="st">"30{30:59}"</span><span class="op">)</span>, <span class="fu">str_glue</span><span class="op">(</span><span class="st">"29{10:29}"</span><span class="op">)</span>, noise_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"999"</span>, <span class="st">"111"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"database"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is a database table</span></span>
<span><span class="co"># note that in-memory SQLite database stores dates as numbers</span></span>
<span><span class="va">claim_db</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 6]</span></span>
<span><span class="co">#&gt; # Database: sqlite 3.51.0 [:memory:]</span></span>
<span><span class="co">#&gt;     uid clnt_id dates diagx diagx_1 diagx_2</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1    59       1 16650 999   &lt;NA&gt;    &lt;NA&gt;   </span></span>
<span><span class="co">#&gt; 2    14       1 17100 3046  3058    &lt;NA&gt;   </span></span>
<span><span class="co">#&gt; 3    65       1 17381 999   &lt;NA&gt;    &lt;NA&gt;   </span></span>
<span><span class="co">#&gt; 4    19       1 17948 2916  2915    999    </span></span>
<span><span class="co">#&gt; 5    71       1 18479 999   999     999    </span></span>
<span><span class="co">#&gt; 6    66       2 16553 999   &lt;NA&gt;    999</span></span></code></pre></div>
<p>Hospitalization</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_test_dat.html">make_test_dat</a></span><span class="op">(</span>vals_kept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">str_glue</span><span class="op">(</span><span class="st">"F{10:19}"</span><span class="op">)</span>, <span class="fu">str_glue</span><span class="op">(</span><span class="st">"F{100:199}"</span><span class="op">)</span>, noise_val <span class="op">=</span> <span class="st">"999"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is a local data.frame/tibble</span></span>
<span><span class="va">hosp_df</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   uid clnt_id      dates diagx diagx_1 diagx_2</span></span>
<span><span class="co">#&gt; 1  96       1 2016-01-04   999     999     999</span></span>
<span><span class="co">#&gt; 2 100       1 2020-09-15   999    &lt;NA&gt;    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3  79       1 2020-12-26   999     999    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4  15       2 2019-08-24  F185    F170    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5  48       2 2020-02-12  F102    F138    F180</span></span>
<span><span class="co">#&gt; 6  10       3 2016-02-06  F163    F174     999</span></span></code></pre></div>
<p>Here’s how you could use <code>healthdb</code> to implement the SUD definition above:</p>
<ol style="list-style-type: decimal">
<li>
<p>Identify rows contains the target codes in the claim database</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result1</span> <span class="op">&lt;-</span> <span class="va">claim_db</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="reference/identify_row.html">identify_row</a></span><span class="op">(</span></span>
<span>vars <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"diagx"</span><span class="op">)</span>,</span>
<span>match <span class="op">=</span> <span class="st">"start"</span>,</span>
<span>vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">291</span><span class="op">:</span><span class="fl">292</span>, <span class="fl">303</span><span class="op">:</span><span class="fl">305</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; ℹ Identify records with condition(s):</span></span>
<span><span class="co">#&gt; • where at least one of the diagx, diagx_1, diagx_2 column(s) in each record</span></span>
<span><span class="co">#&gt; • contains a value satisfied SQL LIKE pattern: 291% OR 292% OR 303% OR 304% OR 305%</span></span>
<span><span class="co">#&gt; ℹ To see the final query generated by 'dbplyr', use dplyr::show_query() on the output.</span></span>
<span><span class="co">#&gt; To extract the SQL string, use dbplyr::remote_query().</span></span></code></pre></div>
</li>
<li>
<p>Restrict the number of records per client</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result2</span> <span class="op">&lt;-</span> <span class="va">result1</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="reference/restrict_n.html">restrict_n</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="va">clnt_id</span>,</span>
<span>  n_per_clnt <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  count_by <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  <span class="co"># here we use filter mode to remove records that failed the restriction</span></span>
<span>  mode <span class="op">=</span> <span class="st">"filter"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ Apply restriction that each client must have at least 2 records with distinct</span></span>
<span><span class="co">#&gt; dates. Clients/groups which did not met the condition were excluded.</span></span>
<span><span class="va">result2</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 7]</span></span>
<span><span class="co">#&gt; # Database: sqlite 3.51.0 [:memory:]</span></span>
<span><span class="co">#&gt;     uid clnt_id dates diagx diagx_1 diagx_2 flag_restrict_n</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;             &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    14       1 17100 3046  3058    &lt;NA&gt;                  1</span></span>
<span><span class="co">#&gt; 2    19       1 17948 2916  2915    999                   1</span></span>
<span><span class="co">#&gt; 3    36       3 17235 3047  3037    999                   1</span></span>
<span><span class="co">#&gt; 4    37       3 17984 3055  292     &lt;NA&gt;                  1</span></span>
<span><span class="co">#&gt; 5    16       3 18169 3051  999     &lt;NA&gt;                  1</span></span>
<span><span class="co">#&gt; 6    49       5 17935 3051  2922    3052                  1</span></span></code></pre></div>
</li>
<li>
<p>Restrict the temporal pattern of diagnoses</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result3</span> <span class="op">&lt;-</span> <span class="va">result2</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="reference/restrict_date.html">restrict_date</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="va">clnt_id</span>,</span>
<span>  date_var <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  within <span class="op">=</span> <span class="fl">365</span>,</span>
<span>  uid <span class="op">=</span> <span class="va">uid</span>,</span>
<span>  <span class="co"># here we use flag mode to flag records that met the restriction instead of removing those</span></span>
<span>  mode <span class="op">=</span> <span class="st">"flag"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ Apply restriction that each client must have 2 records that were within 365</span></span>
<span><span class="co">#&gt; days. Records that met the condition were flagged.</span></span>
<span><span class="va">result3</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 8]</span></span>
<span><span class="co">#&gt; # Database: sqlite 3.51.0 [:memory:]</span></span>
<span><span class="co">#&gt;     uid clnt_id dates diagx diagx_1 diagx_2 flag_restrict_n flag_restrict_date</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;             &lt;int&gt;              &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    14       1 17100 3046  3058    &lt;NA&gt;                  1                  0</span></span>
<span><span class="co">#&gt; 2    19       1 17948 2916  2915    999                   1                  0</span></span>
<span><span class="co">#&gt; 3    36       3 17235 3047  3037    999                   1                  0</span></span>
<span><span class="co">#&gt; 4    37       3 17984 3055  292     &lt;NA&gt;                  1                  1</span></span>
<span><span class="co">#&gt; 5    16       3 18169 3051  999     &lt;NA&gt;                  1                  0</span></span>
<span><span class="co">#&gt; 6    49       5 17935 3051  2922    3052                  1                  1</span></span></code></pre></div>
</li>
<li><p>Repeat these steps for hospitalization and row bind the results.</p></li>
</ol>
<p>The output of these functions, including <code><a href="reference/identify_row.html">identify_row()</a></code>, <code><a href="reference/exclude.html">exclude()</a></code>, <code><a href="reference/restrict_n.html">restrict_n()</a></code>, <code><a href="reference/restrict_date.html">restrict_date()</a></code> and more, can be piped into ‘dplyr’ functions for further manipulations. Therefore, wrangling with them along with ‘dplyr’ provide the maximum flexibility for implementing complex algorithms. However, your code could look repetitive if multiple data sources were involved. See the introduction vignette (<code><a href="articles/healthdb.html">vignette("healthdb")</a></code>) <strong>for a much more concise way to work with multiple sources and definitions</strong> (the ‘Call-building functions’ section).</p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=healthdb" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/KevinHzq/healthdb/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/KevinHzq/healthdb/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing healthdb</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Kevin Hu <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0003-0254-5277" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/KevinHzq/healthdb/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/KevinHzq/healthdb/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://app.codecov.io/gh/KevinHzq/healthdb?branch=master" class="external-link"><img src="https://codecov.io/gh/KevinHzq/healthdb/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://CRAN.R-project.org/package=healthdb" class="external-link"><img src="https://www.r-pkg.org/badges/version/healthdb" alt="CRAN status"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Hu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
