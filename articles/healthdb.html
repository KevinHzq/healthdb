<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to healthdb • healthdb</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to healthdb">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">healthdb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/healthdb.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KevinHzq/healthdb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to healthdb</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KevinHzq/healthdb/blob/master/vignettes/healthdb.Rmd" class="external-link"><code>vignettes/healthdb.Rmd</code></a></small>
      <div class="d-none name"><code>healthdb.Rmd</code></div>
    </div>

    
    
<hr>
<div class="section level2">
<h2 id="sec-what-it-does">What it does<a class="anchor" aria-label="anchor" href="#sec-what-it-does"></a>
</h2>
<ul>
<li><p>This package is designed for identifying disease cases from admin
data for epidemiological studies. The implementation focused on code
readability and re-usability. Three types of functions are
included:</p></li>
<li><p><em>Interactive functions</em> (e.g.,
<code><a href="../reference/identify_row.html">identify_row()</a></code>, <code><a href="../reference/exclude.html">exclude()</a></code>,
<code><a href="../reference/fetch_var.html">fetch_var()</a></code>) based on filter and joins from dplyr with
tweaks that fix SQL translation or add features that are not natively
support by SQL. They also work for local data.frame, and some use
‘data.table’ package
(<code><a href="https://cran.rstudio.com/web/packages/data.table/vignettes/datatable-intro.html" class="external-link">vignette("datatable-intro", package = "data.table")</a></code>) to
speed up processing time for large data. These functions are not as
flexible as <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code>, but they are general enough to
be useful even outside health research.</p></li>
<li><p><em>Call-building functions</em> (e.g., <code><a href="../reference/build_def.html">build_def()</a></code>,
<code><a href="../reference/execute_def.html">execute_def()</a></code>) that facilitate batch execution and re-use
of case definitions. In essence, <code>build_def</code> creates codes of
definitions (which is chain of the interactive functions, e.g.,
<code><a href="../reference/define_case.html">define_case()</a></code>) that are not immediately ran.
<code>execute_def</code> runs built definitions with different input
data.</p></li>
<li><p><em>Miscellaneous functions</em> such as computing age
<code><a href="../reference/compute_duration.html">compute_duration()</a></code>, collapsing records within a time range
into one episode <code><a href="../reference/collapse_episode.html">collapse_episode()</a></code>, and more (on-going
effort). Most of these functions have built-in checks signalling when
things might go wrong, e.g., missing values in calculated ages.</p></li>
</ul>
<div class="section level3">
<h3 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h3>
<p>In health research and surveillance, identifying diseases or events
from administrative databases is often the initial step. However,
crafting case-finding algorithms is a complex task. Existing algorithms,
often written in SAS by experienced analysts, can be complex and
difficult to decipher for the growing number of analysts trained
primarily in R.</p>
<p>These algorithms may also affect performance if they depend on Data
Step in SAS, due to a lack of translation between Data Step and SQL.
This can result in SAS downloading data from a remote database to a
local machine, leading to poor performance when handling large,
population-based databases.</p>
<p>The ‘healthdb’ R package was created to address these challenges. It
minimizes the need to download data and offers an easy-to-use interface
for working with healthcare databases. It also includes capabilities not
supported by ‘SQL’, such as matching strings by ‘stringr’ style regular
expressions, and can compute comorbidity scores
(<code><a href="../reference/compute_comorbidity.html">compute_comorbidity()</a></code>) directly on a database server. This
vignette will present an example of common use cases.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="sec-installation">Installation<a class="anchor" aria-label="anchor" href="#sec-installation"></a>
</h2>
<p>Simply run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"healthdb"</span><span class="op">)</span></span></code></pre></div>
<p>We will need the following packages for this demo.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KevinHzq/healthdb" class="external-link">healthdb</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sec-intended-use-case">Intended use case<a class="anchor" aria-label="anchor" href="#sec-intended-use-case"></a>
</h2>
<p>Consider the case definition of substance use disorder (SUD) from <a href="http://www.bccdc.ca/resource-gallery/Documents/Chronic-Disease-Dashboard/substance-use-disorder.pdf" class="external-link">British
Columbia Centre for Disease Control’s Chronic Disease Dashboard</a>,</p>
<blockquote>
<p>One or more hospitalization with a substance use disorder diagnostic
code, OR Two or more physician visits with a substance use disorder
diagnostic code within one year.</p>
</blockquote>
<p>We are going to implement this definition. First, let’s make a demo
data sets for the two sources:</p>
<ol style="list-style-type: decimal">
<li>
<p>Physician claims with multiple columns of <a href="https://www2.gov.bc.ca/gov/content/health/practitioner-professional-resources/msp/physicians/diagnostic-code-descriptions-icd-9" class="external-link">ICD-9</a>
diagnostic codes</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make_test_dat() makes either a toy data.frame or database table in memory with known number of rows that satisfy the query we will show later</span></span>
<span><span class="va">claim_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_test_dat.html">make_test_dat</a></span><span class="op">(</span>vals_kept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"303"</span>, <span class="st">"304"</span>, <span class="st">"305"</span>, <span class="st">"291"</span>, <span class="st">"292"</span>, <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"30{30:59}"</span><span class="op">)</span>, <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"29{10:29}"</span><span class="op">)</span>, noise_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"999"</span>, <span class="st">"111"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"database"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is a database table</span></span>
<span><span class="co"># note that in-memory SQLite database stores dates as numbers</span></span>
<span><span class="va">claim_db</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 6]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.47.1 [:memory:]</span></span></span>
<span><span class="co">#&gt;     uid clnt_id dates diagx diagx_1 diagx_2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    25       3 <span style="text-decoration: underline;">17</span>909 3030  2921    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    46       4 <span style="text-decoration: underline;">18</span>497 2925  3047    2925   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    79       5 <span style="text-decoration: underline;">16</span>559 999   999     <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    40       5 <span style="text-decoration: underline;">17</span>134 3056  3042    <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    63       5 <span style="text-decoration: underline;">17</span>213 999   999     999    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    77       5 <span style="text-decoration: underline;">17</span>976 999   <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span></span></span></code></pre></div>
</li>
<li>
<p>Hospitalization with <a href="https://en.wikipedia.org/wiki/ICD-10" class="external-link">ICD-10</a> codes</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_test_dat.html">make_test_dat</a></span><span class="op">(</span>vals_kept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"F{10:19}"</span><span class="op">)</span>, <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"F{100:199}"</span><span class="op">)</span>, noise_val <span class="op">=</span> <span class="st">"999"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is a local data.frame/tibble</span></span>
<span><span class="va">hosp_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   uid clnt_id      dates diagx diagx_1 diagx_2</span></span>
<span><span class="co">#&gt; 1 100       1 2015-02-01   999     999     999</span></span>
<span><span class="co">#&gt; 2  85       1 2017-07-17   999    &lt;NA&gt;     999</span></span>
<span><span class="co">#&gt; 3   3       1 2019-06-17  F133    F159     999</span></span>
<span><span class="co">#&gt; 4  65       2 2019-01-08   999    &lt;NA&gt;     999</span></span>
<span><span class="co">#&gt; 5  52       2 2019-06-01   999    &lt;NA&gt;    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6  75       3 2016-07-11   999    &lt;NA&gt;    &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># convert Date to numeric to be consistent with claim_db</span></span>
<span><span class="va">hosp_df</span> <span class="op">&lt;-</span> <span class="va">hosp_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">julian</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="interactive-functions">Interactive functions<a class="anchor" aria-label="anchor" href="#interactive-functions"></a>
</h2>
<p>Let’s focus on the physician claims. Extracting clients with at least
two records within a year is not difficult, and involves only a few
steps. The codes could look like the following using dplyr, however, it
does not work because: 1. SQL does not support multiple patterns in one
LIKE operation, 2. dbply currently have issue with translating
n_distinct.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## not run</span></span>
<span><span class="va">claim_db</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># identify the target codes</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">if_any</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"diagx"</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">str_like</span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"291%"</span>, <span class="st">"292%"</span>, <span class="st">"303%"</span>, <span class="st">"304%"</span>, <span class="st">"305%"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># each clnt has at least 2 records on different dates</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">clnt_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># the n_distinct step is mainly for reducing computation in the next step</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># any two dates within one year?</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">365</span><span class="op">)</span></span>
<span><span class="co">## end</span></span></code></pre></div>
<p>Here’s how you could use <code>healthdb</code> to achieve these
steps:</p>
<ol style="list-style-type: decimal">
<li>
<p>Identify rows contains the target codes. Use
<code><a href="../reference/identify_row.html">?identify_row</a></code> to see a list of supported matching
types.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result1</span> <span class="op">&lt;-</span> <span class="va">claim_db</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/identify_row.html">identify_row</a></span><span class="op">(</span></span>
<span>vars <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"diagx"</span><span class="op">)</span>,</span>
<span>match <span class="op">=</span> <span class="st">"start"</span>,</span>
<span>vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">291</span><span class="op">:</span><span class="fl">292</span>, <span class="fl">303</span><span class="op">:</span><span class="fl">305</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Identify records with condition(s):</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> where at least one of the diagx, diagx_1, diagx_2 column(s) in each record</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> contains a value satisfied SQL LIKE pattern: 291% OR 292% OR 303% OR 304% OR 305%</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> To see the final query generated by 'dbplyr', use dplyr::show_query() on the output.</span></span>
<span><span class="co">#&gt; To extract the SQL string, use dbplyr::remote_query().</span></span></code></pre></div>
</li>
<li>
<p>Bonus: remove clients with exclusion codes</p>
<p>This step is not in the substance use disorder definition, but other
disease definitions often require exclusion of some ICDs that
contradicts the ones of interest. Let’s say we want to remove clients
with code “111” here.</p>
<p>We first identify “111” from the source, then exclude clients in the
output from the previous step’s result. <code><a href="../reference/exclude.html">exclude()</a></code> take
either a data set (via the excl argument) or expression (condition
argument) as input. For the former, it performs an anti join matching on
the by argument (see <code><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">dplyr::join_by()</a></code>). For the latter, it
is the opposite of filter, i.e.,
<code>filter(!(some_expression))</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result2</span> <span class="op">&lt;-</span> <span class="va">result1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/exclude.html">exclude</a></span><span class="op">(</span></span>
<span>excl <span class="op">=</span> <span class="fu"><a href="../reference/identify_row.html">identify_row</a></span><span class="op">(</span><span class="va">claim_db</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"diagx"</span><span class="op">)</span>, <span class="st">"in"</span>, <span class="st">"111"</span><span class="op">)</span>,</span>
<span>by <span class="op">=</span> <span class="st">"clnt_id"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Identify records with condition(s):</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> where at least one of the diagx, diagx_1, diagx_2 column(s) in each record</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> contains a value exactly matched values in set: "111"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Exclude records in `data` through anti_join with `excl` matching on (by argument): "clnt_id"</span></span></code></pre></div>
</li>
<li>
<p>Restrict the number of records per client</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result3</span> <span class="op">&lt;-</span> <span class="va">result2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/restrict_n.html">restrict_n</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="va">clnt_id</span>,</span>
<span>  n_per_clnt <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  count_by <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  <span class="co"># here we use filter mode to remove records that failed the restriction</span></span>
<span>  mode <span class="op">=</span> <span class="st">"filter"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Apply restriction that each client must have at least 2 records with</span></span>
<span><span class="co">#&gt; distinct dates. Clients/groups which did not met the condition were excluded.</span></span></code></pre></div>
</li>
<li>
<p>Restrict the temporal pattern of diagnoses</p>
<p><code><a href="../reference/restrict_date.html">restrict_date()</a></code> supports more complicated patterns like
having n diagnoses at least i days apart within j years. Note that when
SQL interpret order of dates, the result could be not deterministic if
there were duplicate dates within client. Therefore, a unique row id
(uid) has to be supplied to get consistent result.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result4</span> <span class="op">&lt;-</span> <span class="va">result3</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/restrict_date.html">restrict_date</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="va">clnt_id</span>,</span>
<span>  date_var <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  within <span class="op">=</span> <span class="fl">365</span>,</span>
<span>  uid <span class="op">=</span> <span class="va">uid</span>,</span>
<span>  <span class="co"># here we use flag mode to flag records that met the restriction instead of removing those</span></span>
<span>  mode <span class="op">=</span> <span class="st">"flag"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Apply restriction that each client must have 2 records that were</span></span>
<span><span class="co">#&gt; within 365 days. Records that met the condition were flagged.</span></span></code></pre></div>
</li>
<li>
<p>Fetch variables from other tables by matching common keys</p>
<p>Up to this point, the result is only a query and have not been
downloaded. Hopefully, the data has been shrunken to a manageable size
for collection.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Class of result4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">result4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tbl_SQLiteConnection" "tbl_dbi"              "tbl_sql"             </span></span>
<span><span class="co">#&gt; [4] "tbl_lazy"             "tbl"</span></span>
<span></span>
<span><span class="co"># execute query and download the result</span></span>
<span><span class="va">result_df</span> <span class="op">&lt;-</span> <span class="va">result4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Number of rows in source</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">claim_db</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span></span>
<span><span class="co"># Number of rows in the current result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 27</span></span></code></pre></div>
<p>Our data now only contains diagnoses which are probably not enough
for further analyses. Let’s say we want to gather client demographics
such as age and sex from other sources. This certainly can be done with
multiple <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::left_join()</a></code> calls. Here we provide the
<code><a href="../reference/fetch_var.html">fetch_var()</a></code> function to make the codes more concise. Note
that the input must be a named object and not from a pipe (i.e., don’t
do this <code>data %&gt;% some_action %&gt;% fetch_var()</code>).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make two look up tables</span></span>
<span><span class="va">age_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">90</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>  sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"F"</span>, <span class="st">"M"</span><span class="op">)</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">address_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  clnt_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, <span class="fl">5</span><span class="op">)</span>, year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2016</span><span class="op">:</span><span class="fl">2020</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>  area_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">200</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get year from dates for matching</span></span>
<span></span>
<span><span class="va">result_df</span> <span class="op">&lt;-</span> <span class="va">result_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">dates</span>, origin <span class="op">=</span> <span class="st">"1970-01-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># note that keys must be present in all tables</span></span>
<span><span class="fu"><a href="../reference/fetch_var.html">fetch_var</a></span><span class="op">(</span><span class="va">result_df</span>,</span>
<span>          keys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">clnt_id</span>, <span class="va">year</span><span class="op">)</span>,</span>
<span>          linkage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            <span class="co"># the formula means from_table ~ get_variable</span></span>
<span>            <span class="co"># |clnt_id means matching on clnt_id only</span></span>
<span>            <span class="va">age_tab</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">|</span> <span class="va">clnt_id</span>,</span>
<span>            <span class="va">address_tab</span> <span class="op">~</span> <span class="va">area_code</span></span>
<span>          <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">uid</span>, <span class="va">clnt_id</span>, <span class="va">dates</span>, <span class="va">age</span>, <span class="va">sex</span>, <span class="va">area_code</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;     uid clnt_id dates   age sex   area_code</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1      18 <span style="text-decoration: underline;">16</span>988     4 M           193</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    34      18 <span style="text-decoration: underline;">17</span>810     4 M           193</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    45      20 <span style="text-decoration: underline;">16</span>517    62 M            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    39      20 <span style="text-decoration: underline;">17</span>305    62 M           154</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    33      21 <span style="text-decoration: underline;">16</span>451     8 F            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    50      21 <span style="text-decoration: underline;">16</span>818     8 F           196</span></span></code></pre></div>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="call-building-functions">Call-building functions<a class="anchor" aria-label="anchor" href="#call-building-functions"></a>
</h2>
<p>To complete the definition, we need to repeat the process shown above
with hospitalization data. Some studies may use more than a handful of
data sources to define their sample. We packed steps 1-4 in one function
<code><a href="../reference/define_case.html">define_case()</a></code>, and provide tools to perform batch execution
with different data and parameters to meet those needs.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># build the full definition of SUD</span></span>
<span><span class="va">sud_def</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_def.html">build_def</a></span><span class="op">(</span></span>
<span>  <span class="co"># name of definition</span></span>
<span>  def_lab <span class="op">=</span> <span class="st">"SUD"</span>,</span>
<span>  <span class="co"># place holder names for sources</span></span>
<span>  src_labs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"claim"</span>, <span class="st">"hosp"</span><span class="op">)</span>,</span>
<span>  def_fn <span class="op">=</span> <span class="va">define_case</span>, <span class="co"># you could alter it and supply your own function</span></span>
<span>  <span class="co"># below are argumets of define_case</span></span>
<span>  fn_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># if length = 1, the single element will be use for every source</span></span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"diagx"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    match <span class="op">=</span> <span class="st">"start"</span>, <span class="co"># match ICD starts with vals</span></span>
<span>    vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">291</span><span class="op">:</span><span class="fl">292</span>, <span class="fl">303</span><span class="op">:</span><span class="fl">305</span><span class="op">)</span>, <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"F{10:19}"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    clnt_id <span class="op">=</span> <span class="va">clnt_id</span>,</span>
<span>    n_per_clnt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    date_var <span class="op">=</span> <span class="va">dates</span>,</span>
<span>    within <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">365</span>, <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="va">uid</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"flag"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sud_def</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   def_lab src_labs def_fn      fn_args          fn_call   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> SUD     claim    define_case <span style="color: #949494;">&lt;named list [9]&gt;</span> <span style="color: #949494;">&lt;language&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> SUD     hosp     define_case <span style="color: #949494;">&lt;named list [9]&gt;</span> <span style="color: #949494;">&lt;language&gt;</span></span></span></code></pre></div>
<p>Let’s look inside the fn_call list column. Two calls of
<code><a href="../reference/define_case.html">define_case()</a></code> have been made with different parameters. The
data arguments are left empty on purpose for re-usability. For example,
you may want to repeat the analysis with data from different regions or
study periods.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sud_def</span><span class="op">$</span><span class="va">fn_call</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; define_case(data = , vars = starts_with("diagx"), match = "start", </span></span>
<span><span class="co">#&gt;     vals = c(291:292, 303:305), clnt_id = clnt_id, n_per_clnt = 2, </span></span>
<span><span class="co">#&gt;     date_var = dates, within = 365, uid = uid, mode = "flag")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; define_case(data = , vars = starts_with("diagx"), match = "start", </span></span>
<span><span class="co">#&gt;     vals = glue("F{10:19}"), clnt_id = clnt_id, n_per_clnt = 1, </span></span>
<span><span class="co">#&gt;     date_var = dates, within = NULL, uid = uid, mode = "flag")</span></span></code></pre></div>
<p>Executing the definition is simply a call of
<code><a href="../reference/execute_def.html">execute_def()</a></code>. If verbose option is not turned off by
<code>options(healthdb.verbose = FALSE)</code>, the output message will
explain what has been done. You could append multiple
<code><a href="../reference/build_def.html">build_def()</a></code> outputs together and execute them all at once.
Definition and source labels will be added to the result to identify
outputs from different calls.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># execute the definition</span></span>
<span><span class="va">result_list</span> <span class="op">&lt;-</span> <span class="va">sud_def</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/execute_def.html">execute_def</a></span><span class="op">(</span>with_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    claim <span class="op">=</span> <span class="va">claim_db</span>,</span>
<span>    hosp <span class="op">=</span> <span class="va">hosp_df</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Actions for definition SUD using source claim_db:</span></span>
<span><span class="co">#&gt; → --------------Inclusion step--------------</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Identify records with condition(s):</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> where at least one of the diagx, diagx_1, diagx_2 column(s) in each record</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> contains a value satisfied SQL LIKE pattern: 291% OR 292% OR 303% OR 304% OR 305%</span></span>
<span><span class="co">#&gt; → --------------No. rows restriction--------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Apply restriction that each client must have at least 2 records with distinct dates. Records that met the condition were flagged.</span></span>
<span><span class="co">#&gt; → --------------Time span restriction--------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Apply restriction that each client must have 2 records that were within 365 days. Records that met the condition were flagged.</span></span>
<span><span class="co">#&gt; → -------------- Output all records--------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Actions for definition SUD using source hosp_df:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; → --------------Inclusion step--------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ℹ</span> Identify records with condition(s):</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> where at least one of the diagx, diagx_1, diagx_2 column(s) in each record</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> contains a value satisfied regular expression: ^F10|^F11|^F12|^F13|^F14|^F15|^F16|^F17|^F18|^F19</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All unique value(s) and frequency in the result (as the conditions require just one of the columns containing target values; irrelevant values may come from other vars columns): </span></span>
<span><span class="co">#&gt;  999  F10 F101 F103 F104 F105 F107 F108 F109 F111 F112 F113 F114 F115 F116 F117 </span></span>
<span><span class="co">#&gt;    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 </span></span>
<span><span class="co">#&gt; F118 F119  F12 F121 F122 F123 F124 F125 F128 F129  F13 F132 F133 F134 F135 F137 </span></span>
<span><span class="co">#&gt;    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 </span></span>
<span><span class="co">#&gt; F138  F14 F140 F141 F143 F144 F145 F146 F147  F15 F154 F155 F159  F16 F160 F161 </span></span>
<span><span class="co">#&gt;    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 </span></span>
<span><span class="co">#&gt; F162 F164 F165 F166 F168  F17 F170 F172 F173 F174 F175 F176 F179 F181 F183 F184 </span></span>
<span><span class="co">#&gt;    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1 </span></span>
<span><span class="co">#&gt; F185 F187 F188 F189  F19 F191 F192 F193 F196 F197 F198 NA's </span></span>
<span><span class="co">#&gt;    1    1    1    1    1    1    1    1    1    1    1    1</span></span>
<span><span class="co">#&gt; → -------------- Output all records--------------</span></span></code></pre></div>
<p>Let’s check the results!</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view the results</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span><span class="va">result_list</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 10]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.47.1 [:memory:]</span></span></span>
<span><span class="co">#&gt;   def   src     uid clnt_id dates diagx diagx_1 diagx_2 flag_restrict_n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> SUD   claim    25       3 <span style="text-decoration: underline;">17</span>909 3030  2921    <span style="color: #BB0000;">NA</span>                    0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> SUD   claim    46       4 <span style="text-decoration: underline;">18</span>497 2925  3047    2925                  0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> SUD   claim    40       5 <span style="text-decoration: underline;">17</span>134 3056  3042    <span style="color: #BB0000;">NA</span>                    0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> SUD   claim    10       8 <span style="text-decoration: underline;">17</span>237 2912  3057    999                   0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> SUD   claim    41      12 <span style="text-decoration: underline;">17</span>520 3047  3049    2915                  0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> SUD   claim    22      13 <span style="text-decoration: underline;">18</span>489 3045  3042    <span style="color: #BB0000;">NA</span>                    0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: flag_restrict_date &lt;int&gt;</span></span></span>
<span><span class="co">#&gt;   def  src uid clnt_id dates diagx diagx_1 diagx_2</span></span>
<span><span class="co">#&gt; 1 SUD hosp   3       1 18064  F133    F159     999</span></span>
<span><span class="co">#&gt; 2 SUD hosp  38       4 16625  F191    F147     999</span></span>
<span><span class="co">#&gt; 3 SUD hosp  17       4 17279  F114    F154     999</span></span>
<span><span class="co">#&gt; 4 SUD hosp  30       5 16614  F101    F107    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5 SUD hosp  27       5 17079  F165    F174    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6 SUD hosp  24       5 17414  F118    F111    &lt;NA&gt;</span></span></code></pre></div>
<p>At this point, the result from the claim database
(<code>result[[1]]</code>) has not been collected locally. You could
collect it manually, do further filtering, and then combine with the
result from hospitalization data in any way you want. If you just need a
simple row bind, we have <code><a href="../reference/bind_source.html">bind_source()</a></code> with convenient
naming feature.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bind_source.html">bind_source</a></span><span class="op">(</span><span class="va">result_list</span>,</span>
<span>  <span class="co"># output_name = c(names in the list elements)</span></span>
<span>  src <span class="op">=</span> <span class="st">"src"</span>,</span>
<span>  uid <span class="op">=</span> <span class="st">"uid"</span>,</span>
<span>  clnt_id <span class="op">=</span> <span class="st">"clnt_id"</span>,</span>
<span>  flag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flag_restrict_date"</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  <span class="co"># force_proceed is needed to collect remote tables to local memory</span></span>
<span>  force_proceed <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 5</span></span></span>
<span><span class="co">#&gt;    src_No src     uid clnt_id  flag</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      1 claim    25       3     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      1 claim    46       4     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      1 claim    40       5     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      1 claim    10       8     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      1 claim    41      12     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      1 claim    22      13     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      1 claim     3      15     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      1 claim    14      16     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      1 claim    26      17     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      1 claim     1      18     0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre></div>
<p><code><a href="../reference/pool_case.html">pool_case()</a></code> goes a few steps further than row bind. It
also filters records with valid flags and can summarize by client/group.
Since we had to decide which variables to be summarized in advance, the
output may not be flexible enough to meet your needs.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pool_case.html">pool_case</a></span><span class="op">(</span><span class="va">result_list</span>,</span>
<span>          def <span class="op">=</span> <span class="va">sud_def</span>,</span>
<span>          <span class="co"># your could skip summary with output_lvl = "raw"</span></span>
<span>          output_lvl <span class="op">=</span> <span class="st">"clnt"</span>,</span>
<span>          <span class="co"># include records only from sources having valid records, see function documentation for more detail and other options</span></span>
<span>          include_src <span class="op">=</span> <span class="st">"has_valid"</span>,</span>
<span>          force_proceed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 29 × 8</span></span></span>
<span><span class="co">#&gt;    def   clnt_id first_valid_date last_entry_date raw_in_claim raw_in_hosp</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SUD         1            <span style="text-decoration: underline;">18</span>064           <span style="text-decoration: underline;">18</span>064            0           1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SUD         4            <span style="text-decoration: underline;">16</span>625           <span style="text-decoration: underline;">17</span>279            0           2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SUD         5            <span style="text-decoration: underline;">16</span>614           <span style="text-decoration: underline;">17</span>414            0           3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SUD         7            <span style="text-decoration: underline;">17</span>700           <span style="text-decoration: underline;">17</span>865            0           2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SUD         8            <span style="text-decoration: underline;">17</span>821           <span style="text-decoration: underline;">18</span>135            0           2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SUD         9            <span style="text-decoration: underline;">17</span>637           <span style="text-decoration: underline;">18</span>344            0           3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SUD        11            <span style="text-decoration: underline;">17</span>675           <span style="text-decoration: underline;">18</span>395            0           3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SUD        12            <span style="text-decoration: underline;">17</span>888           <span style="text-decoration: underline;">17</span>888            0           1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SUD        13            <span style="text-decoration: underline;">18</span>342           <span style="text-decoration: underline;">18</span>342            0           1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SUD        16            <span style="text-decoration: underline;">18</span>088           <span style="text-decoration: underline;">18</span>088            0           1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 19 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: valid_in_claim &lt;int&gt;, valid_in_hosp &lt;int&gt;</span></span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Hu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
